<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Business Onboarding</title>
    <link rel="icon" type="image/x-icon" href="public/stress.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
        }
        .auth-card {
            max-width: 650px;
            width: 100%;
        }
        .form-container {
            display: block;
        }
        .day-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .hours-row {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: none;
        }
        .hours-row.show {
            display: block;
        }
    </style>
</head>
<body>


<div class="container d-flex justify-content-center align-items-center">

    <div class="card shadow-sm p-4 auth-card">

        <div class="form-container" id="business-signup-form">
            <h2 class="text-center mb-4">Business Signup</h2>
            <form enctype="multipart/form-data" id="business-signup-form-element">
                <input type="hidden" name="mode" value="signup">
                <input type="hidden" name="role" value="business">
                
                <div class="mb-3">
                    <input type="text" name="uen" class="form-control" placeholder="UEN" required>
                </div>
                <div class="mb-3">
                    <input type="text" name="businessName" class="form-control" placeholder="Business Name" required>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Please enter your postal code</label>
                        <input type="text" class="form-control" placeholder="Postal Code" id="postalCode">
                    </div>
                    <div class="col-md-9 mt-5">
                        <input type="text" name="address" class="form-control" placeholder="Address" id="address">
                    </div>
                    
                </div>
                <div class="mb-3">
                    <label class="form-label">Business Category</label>
                    <select name="businessCategory" class="form-select">
                        <option value="">Select a category</option>
                        <option value="fnb">F&B</option>
                        <option value="retail">Retail</option>
                        <option value="services">Services</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="health_wellness">Health/Wellness</option>
                        <option value="professional_services">Professional Services</option>
                        <option value="home_living">Home and Living</option>
                    </select>
                </div>
                <div class="mb-3">
                    <textarea name="description" class="form-control" placeholder="Description" rows="3"></textarea>
                </div>

                <!-- Opening Hours Section -->
                <div class="mb-3">
                    <label class="form-label d-block">Opening Hours</label>
                    
                    <!-- 24/7 Checkbox -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="open247" id="open-247" value="1">
                        <label class="form-check-label" for="open-247">
                            <strong>Open 24/7</strong>
                        </label>
                    </div>

                    <!-- Day Selection -->
                    <div id="day-selection-container">
                        <label class="form-label">Which days of the week is your business open?</label>
                        <div class="day-selection mb-3">
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="monday" id="day-monday" data-day="monday">
                                <label class="form-check-label" for="day-monday">Monday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="tuesday" id="day-tuesday" data-day="tuesday">
                                <label class="form-check-label" for="day-tuesday">Tuesday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="wednesday" id="day-wednesday" data-day="wednesday">
                                <label class="form-check-label" for="day-wednesday">Wednesday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="thursday" id="day-thursday" data-day="thursday">
                                <label class="form-check-label" for="day-thursday">Thursday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="friday" id="day-friday" data-day="friday">
                                <label class="form-check-label" for="day-friday">Friday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="saturday" id="day-saturday" data-day="saturday">
                                <label class="form-check-label" for="day-saturday">Saturday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input day-checkbox" type="checkbox" value="sunday" id="day-sunday" data-day="sunday">
                                <label class="form-check-label" for="day-sunday">Sunday</label>
                            </div>
                        </div>

                        <!-- Hours Input Fields -->
                        <div id="hours-container">
                            <div class="hours-row" id="hours-monday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Monday</strong></div>
                                    <div class="col-4"><input type="time" data-day="monday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="monday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                            <div class="hours-row" id="hours-tuesday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Tuesday</strong></div>
                                    <div class="col-4"><input type="time" data-day="tuesday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="tuesday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                            <div class="hours-row" id="hours-wednesday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Wednesday</strong></div>
                                    <div class="col-4"><input type="time" data-day="wednesday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="wednesday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                            <div class="hours-row" id="hours-thursday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Thursday</strong></div>
                                    <div class="col-4"><input type="time" data-day="thursday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="thursday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                            <div class="hours-row" id="hours-friday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Friday</strong></div>
                                    <div class="col-4"><input type="time" data-day="friday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="friday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                            <div class="hours-row" id="hours-saturday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Saturday</strong></div>
                                    <div class="col-4"><input type="time" data-day="saturday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="saturday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                            <div class="hours-row" id="hours-sunday">
                                <div class="row align-items-center">
                                    <div class="col-3"><strong>Sunday</strong></div>
                                    <div class="col-4"><input type="time" data-day="sunday" data-type="open" class="form-control form-control-sm hours-input"></div>
                                    <div class="col-1 text-center">to</div>
                                    <div class="col-4"><input type="time" data-day="sunday" data-type="close" class="form-control form-control-sm hours-input"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <input type="email" name="email" class="form-control" placeholder="Business Email" required>
                </div>
                <div class="mb-3">
                    <input type="tel" name="phoneNumber" class="form-control" placeholder="Phone Number">
                </div>
                <div class="mb-3">
                    <input type="url" name="websiteLink" class="form-control" placeholder="Website Link (https://)">
                </div>
                <div class="mb-3">
                    <input type="url" name="socialMediaLink" class="form-control" placeholder="Social Media Link">
                </div>
                <div class="mb-3">
                    <label class="form-label">Business Wallpaper</label>
                    <input type="file" name="wallpaper" id="wallpaper-upload" class="form-control" accept="image/*">
                    <input type="hidden" id="wallpaper-url" name="wallpaper">
                    <div id="upload-status" class="form-text text-muted"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Price Tier</label>
                    <select name="priceTier" class="form-select" required>
                        <option value="">Select price tier</option>
                        <option value="low">$ (Budget-friendly)</option>
                        <option value="medium">$$ (Moderate)</option>
                        <option value="high">$$$ (Premium)</option>
                    </select>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" name="offersDelivery" class="form-check-input" value="1">
                    <label class="form-check-label">Offers Delivery</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" name="offersPickup" class="form-check-input" value="1">
                    <label class="form-check-label">Offers Pickup</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Payment Options</label>
                    <select name="paymentOptions[]" class="form-select" multiple size="4" required>
                        <option value="cash">Cash</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="paynow">PayNow</option>
                        <option value="digital_wallets">Digital Wallets (Apple/Google/Samsung/GrabPay)</option>
                    </select>
                    <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple options.</small>
                </div>

                <button type="submit" class="btn btn-success w-100">
                    SIGN UP!
                </button>

            </form>
        </div>

    </div>
</div>

<script>
    const open247Checkbox = document.getElementById('open-247');
    const daySelectionContainer = document.getElementById('day-selection-container');
    const dayCheckboxes = document.querySelectorAll('.day-checkbox');
    const businessSignupFormElement = document.getElementById('business-signup-form-element');

    open247Checkbox.addEventListener('change', function() {
        if (this.checked) {
            daySelectionContainer.style.display = 'none';
            dayCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                const day = checkbox.getAttribute('data-day');
                const hoursRow = document.getElementById(`hours-${day}`);
                hoursRow.classList.remove('show');
            });
        } else {
            daySelectionContainer.style.display = 'block';
        }
    });

    dayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.getAttribute('data-day');
            const hoursRow = document.getElementById(`hours-${day}`);
            if (this.checked) {
                hoursRow.classList.add('show');
            } else {
                hoursRow.classList.remove('show');
                const inputs = hoursRow.querySelectorAll('.hours-input');
                inputs.forEach(input => input.value = '');
            }
        });
    });
    async function getAuthToken() {
        try {
            const response = await axios.post('https://www.onemap.gov.sg/api/auth/post/getToken', {
                email: 'pamika.lim.2024@computing.smu.edu.sg',     
                password: 'mTW!dR$M!ZVRX5h'            
            });
            return response.data.access_token;
        } catch (error) {
            console.error('Failed to get OneMap token:', error);
            return null;
        }
    };    
    async function getAddress() {
        const postalCode = document.getElementById('postalCode');
        const address = document.getElementById('address');
        const url = 'https://www.onemap.gov.sg/api/common/elastic/search';
        // const authToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo5ODY3LCJmb3JldmVyIjpmYWxzZSwiaXNzIjoiT25lTWFwIiwiaWF0IjoxNzYyMDc4NzY4LCJuYmYiOjE3NjIwNzg3NjgsImV4cCI6MTc2MjMzNzk2OCwianRpIjoiYTZlMDZlYTMtNmYxZS00M2E4LWI1MzEtZjQwYjY0NWJlNjUwIn0.yR4jq5XwdTpe2UeUfchgn_Oofq_Ry7Fyez-j_CxXADoVdBfB6ugV4BjHfyNqbubnqA57NufaACp2KM_M-5cvbmdSEvdmIskz1PUKPrG1G8Sl1GfdXI3uMZK7_4Qf0-7dW69ZJPfegm7Vwh9B2VnLEak226rhkRpC4PAsaMgi2fN4-2Xsvm-wh66-Yd5bxOtmXZNYT8QALsRmP5BbE1FqSjq8nmdZbzZgGMKFop0s0lWspgxswZjKspuywK0gQArI7OTcnSt4Mrk9oTvIF6BKJEQgTwBd9bdGSf4f7kHzHsOBVdXiVg8Bg3mGt1OPZQgjkl-s6vn5cjDGfkpv4mGqEg';
            
        const authToken = await getAuthToken();

        if (postalCode.value.length == 6 && !isNaN(postalCode.value)) {
            try {
                const response = await axios.get(url, {
                    params: {
                        'searchVal': postalCode.value,
                        'returnGeom': 'N',
                        'getAddrDetails': 'Y'
                    },
                    headers: { 'Authorization': `${authToken}` }
                });
                address.value = response.data.results[0].ADDRESS;
                const { lat, lng} = await getLatLng(address.value);
                console.log('Lat', lat);
                console.log('Lng', lng);
            } catch (error) {
                console.log(`something went wrong: ${error}`);
            }
        } else {
            address.value = '';
        }
    }
    // add function to call google api to return back lat/lng
    async function getLatLng (address){
        if (!address || address.trim() === '') {
        console.warn('Address is empty. Skipping geocoding.');
        return { lat: '', lng: '' };
    }
        const apiKey = 'AIzaSyCn-aVVBxUbCBYihIeKHePKcTq7O4KfMlY'; 
    const encodedAddress = encodeURIComponent(address);
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;
    
    try {
        const response = await axios.get(url);
        if (response.data.status === 'OK' && response.data.results.length > 0) {
            const location = response.data.results[0].geometry.location;
            return {
                lat: location.lat,
                lng: location.lng,
            };
            
        } else {
            console.warn('No results found for address:', address);
            return { lat: '', lng: '' };

        }
    } catch (error) {
        console.error('Error fetching lat/lng:', error);
        return { lat: '', lng: '' };
    }
    }
    
    // const latitude = returnedlatlng.lat;
    // const longitude = returnedlatlng.lng;
    const postalCodeInput = document.getElementById('postalCode');
    postalCodeInput.addEventListener('keyup', getAddress);

    businessSignupFormElement.addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        try {
const fileInput = document.getElementById('wallpaper-upload');
const file = fileInput.files[0];
let finalWallpaperUrl = '';

// only execute the block if there is an attached file
if (file) {

    // get the url and filename
    const { data: sasData } = await axios.get(`/api/url-generator?filename=${file.name}`) 
    
    // upload to the container
    await axios.put(sasData.uploadUrl, file, {
        headers: {
            'Content-Type': file.type,
            'x-ms-blob-type': 'BlockBlob'
        }
    });

    // build the url and put it into the form (hidden input) because the url must be stored in the db
    finalWallpaperUrl = `https://localoco.blob.core.windows.net/images/${sasData.blobName}`;
    document.getElementById('wallpaper-url').value = finalWallpaperUrl;

} 
else {
    document.getElementById('wallpaper-url').value = '';
}

            uploadStatusEl.textContent = 'Finalizing registration...';
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const openingHours = {};
            dayCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const day = checkbox.getAttribute('data-day');
                    const hoursRow = document.getElementById(`hours-${day}`);
                    const openTime = hoursRow.querySelector('[data-type="open"]').value;
                    const closeTime = hoursRow.querySelector('[data-type="close"]').value;
                    if (openTime && closeTime) {
                        openingHours[day] = { open: openTime, close: closeTime };
                    }
                }
            });
            const { lat, lng } = await getLatLng(document.getElementById('address').value);
            
            const finalPayload = {
                ...data,
                latitude: lat,
                longitude: lng,
                open247: data.open247 === "1",
                offersDelivery: data.offersDelivery === "1",
                offersPickup: data.offersPickup ==="1",
                openingHours: openingHours
            };

            const response = await axios.post('/api/register-business', finalPayload);

            uploadStatusEl.textContent = 'Success! Redirecting...';
            alert('Business Registered Successfully!');
            window.location.href = '/'; 

        } catch (error) {
            console.error('Registration failed:', error);
            alert('Registration failed. Please check the console for errors.');
            submitButton.disabled = false;
            uploadStatusEl.textContent = 'An error occurred. Please try again.';
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>